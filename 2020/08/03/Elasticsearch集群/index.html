<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">




    <meta name="keywords" content=""/>



    <meta name="description" content="Elasticsearch集群搭建1.1 安装准备
1.1.1**下载安装包**
https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.2.2.tar.gz
1.1.2 服务器准备
为搭建ElasticSear..."/>


<meta name="Robots" content="all">


    <title>Augustxuesong | Elasticsearch集群搭建</title>


<link rel="icon" href="/images/favicon.ico">

<link rel="stylesheet" href="/css/font-awesome.min.css">


<link rel="stylesheet" href="/css/atom-one-dark.css">


<link rel="stylesheet" href="/css/style.css">


<script src="/js/highlight.min.js"></script>

<meta name="generator" content="Hexo 5.2.0"></head>
<body>
    <div class="main-container">
        <header class="header">
    <div class="global-width">
        <nav class="nav-box">
            
                <a class="nav-item" href="/"
                
                >Home</a>
            
                <a class="nav-item" href="/resume"
                
                >Resume</a>
            
                <a class="nav-item" href="/mood"
                
                   target="_blank"
                
                >Mood</a>
            
                <a class="nav-item" href="/amusement/tetris"
                
                   target="_blank"
                
                >Amusement</a>
            
                <a class="nav-item" href="/about"
                
                >About</a>
            
        </nav>
    </div>
</header>

        <section class="content global-width">
            <div class="main">
                <article class="box post">
    <div class="post-title align-center detail-title">Elasticsearch集群搭建</div>
    <div class="post-meta align-center">
        
        <i class="fa fa-calendar"></i> <time>2020-08-03</time>
        <span class="dotted">|</span>
        <i class="fa fa-user"></i> 
        
    </div>

    <div class="post-content">
        <h2 id="Elasticsearch集群搭建"><a href="#Elasticsearch集群搭建" class="headerlink" title="Elasticsearch集群搭建"></a>Elasticsearch集群搭建</h2><p><strong>1.1</strong> <strong>安装准备</strong></p>
<p><strong>1.1.1**</strong>下载安装包**</p>
<p><a target="_blank" rel="noopener" href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.2.2.tar.gz">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.2.2.tar.gz</a></p>
<p><strong>1.1.2</strong> <strong>服务器准备</strong></p>
<p>为搭建ElasticSearch集群，准备了二台服务器，主机IP分别为：</p>
<table>
<thead>
<tr>
<th><strong>服务器IP</strong></th>
<th><strong>系统版本</strong></th>
</tr>
</thead>
<tbody><tr>
<td>192.168.102.151</td>
<td>Centos7.5</td>
</tr>
<tr>
<td>192.168.102.11</td>
<td>Centos7.5</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>1.1.3</strong> <strong>新建用户</strong></p>
<p>ES不支持root用户启动，分别使用root用户登录服务器新建es用户,并设置密码，然后给用户文件夹所有权</p>
<p># 新增用户</p>
<p>useradd es</p>
<p># 设置密码</p>
<p>passwd es</p>
<p># 授权</p>
<p>chown es /home/es</p>
<p># 新建es数据文件夹和日志文件夹</p>
<p>mkdir -p /opt/es/logs</p>
<p>mkdir -p /opt/es/data</p>
<p>chown es /opt/es/</p>
<p>chown es /opt/es/logs/</p>
<p>chown es /opt/es/data/</p>
<p># 准备安装包</p>
<p>1、jdk-8u144-linux-x64.tar.gz<br> 2、elasticsearch-6.2.2.tar.gz</p>
<p><strong>1.1.4</strong> <strong>调整系统参数</strong></p>
<p><strong>1.1.3.1</strong> <strong>内核参数调整</strong></p>
<p>vim /etc/sysctl.conf</p>
<p># 增加下面的内容</p>
<p>fs.file-max = 65536</p>
<p>vm.max_map_count = 262144</p>
<p># 执行命令</p>
<p>sysctl -p</p>
<p><strong>1.1.3.2</strong> <strong>资源参数调整</strong></p>
<p>vim /etc/security/limits.conf</p>
<p># 修改</p>
<p>* soft nofile 65536</p>
<p>* hard nofile 65536</p>
<p>* soft nproc 2048</p>
<p>* hard nproc 4096</p>
<p>es soft memlock unlimited</p>
<p>es hard memlock unlimited</p>
<p><strong>1.1.3.3</strong> <strong>调整线程数</strong></p>
<p>vim /etc/security/limits.d/90-nproc.conf</p>
<p>找到如下内容：</p>
<p>* soft nproc 1024</p>
<p>#修改为</p>
<p>* soft nproc 2048</p>
<p><strong>1.2 JDK**</strong>安装**</p>
<p>登录es用户，进入/opt文件夹，解压JDK安装包<br> ES5.0以上必须1.8JDK支持</p>
<p>cd /opt</p>
<p>tar -zxvf /home/es/jdk-8u144-linux-x64.tar.gz</p>
<p># 设置环境变量</p>
<p>vim /etc/profile</p>
<p>#在文件最下方添加</p>
<p>export JAVA_HOME=/opt/jdk1.8.0_144</p>
<p>export CLASSPATH=$CLASSPATH:$JAVA_HOME/lib/*.jar</p>
<p>export PATH=.:$JAVA_HOME/bin:$PATH</p>
<p><strong>1.3 ES**</strong>安装及配置**</p>
<p><strong>1.3.1</strong> <strong>解压缩</strong></p>
<p># 切换到es用户</p>
<p>cd /home/es</p>
<p>tar -zxvf elasticsearch-6.2.2.tar.gz</p>
<p><strong>1.3.2</strong> <strong>配置</strong></p>
<p><strong>1.3.2.1 elasticsearch.yml</strong></p>
<p>cluster.name: my-social</p>
<p>node.name: social-151</p>
<p>network.host: 192.168.102.151</p>
<p>node.master: true</p>
<p>node.data: true</p>
<p>path.data: /opt/es/data</p>
<p>path.logs: /opt/es/logs</p>
<p>http.cors.enabled: true</p>
<p>http.ors.allow-origin: “*”</p>
<p>discovery.zen.ping.unicast.hosts: [“192.168.102.11”,”192.168.102.151”]                                  </p>
<p># 集群名称，各个节点的值必须一致</p>
<p>cluster.name: elasticsearch_production</p>
<p># 节点名称，区分节点，各个节点的值不能一致</p>
<p>node.name: node-1</p>
<p># 数据文件路径</p>
<p>path.data: /opt/es/data</p>
<p># 日志文件路径</p>
<p>path.logs: /opt/es/logs</p>
<p># 设置为true来锁住内存。因为当jvm开始swapping时es的效率会降低，所以要保证它不swap，可以把ES_MIN_MEM和ES_MAX_MEM两个环境变量设置成同一个值，并且保证机器有足够的内存分配给es。同时也要允许elasticsearch的进程可以锁住内存，Linux下可以通过ulimit -l unlimited命令</p>
<p>bootstrap.memory_lock: true</p>
<p># 因为Centos6不支持SecComp，而ES5.6.4默认bootstrap.system_call_filter为true进行检测，所以导致检测失败，失败后直接导致ES不能启动</p>
<p>bootstrap.system_call_filter: false</p>
<p># 本机IP</p>
<p>network.host: 192.168.6.104</p>
<p># 单播列表</p>
<p>discovery.zen.ping.unicast.hosts: [“192.168.102.151”, “192.168.102.11”, “192.168.102.40”]</p>
<p># 防止脑裂，官方推荐设置成 N/2 + 1，N是集群中master节点的数量</p>
<p>discovery.zen.minimum_master_nodes: 2</p>
<p># 存在至少2个节点（数据节点或者 master 节点）才进行数据恢复</p>
<p>gateway.recover_after_nodes: 2</p>
<p># 等待10分钟，或者3个节点上线后，才进行数据恢复，这取决于哪个条件先达到</p>
<p>gateway.expected_nodes: 3</p>
<p>gateway.recover_after_time: 10m</p>
<p># 禁用xpack安全认证</p>
<p>xpack.security.enabled: false</p>
<p><strong>1.3.2.2 jvm.options</strong></p>
<p># 调整内存大小根据系统资源而定，最好不要超过总资源一半</p>
<p>-Xms8g</p>
<p>-Xmx8g</p>
<p><strong>1.3.2.3 elasticsearch**</strong>和elasticsearch-plugin**</p>
<p>可选步骤，如果环境变量配置JDK为1.8不需要配置，若需要多JDK共同使用则需要配置</p>
<p>export JAVA_HOME=/opt/jdk1.8.0_144</p>
<p>export CLASSPATH=$CLASSPATH:$JAVA_HOME/lib/*.jar</p>
<p>export PATH=.:$JAVA_HOME/bin:$PATH</p>
<p><strong>1.3.4</strong> <strong>启动</strong></p>
<p>cd /home/es/elasticsearch-6.2.2/bin</p>
<p># 控制台启动，加 -d 参数可以后台启动</p>
<p>./elasticsearch    </p>
<p># 查看节点状态</p>
<p>curl -XGET ‘192.168.102.151:9200/_cat/nodes?v’</p>
<p># 查看集群状态</p>
<p>curl -XGET ‘192.168.102.11:9200/_cat/health?v’</p>
<p><strong>1.4 head**</strong>的安装**</p>
<p>//下载源码</p>
<p>（1）git clone git://github.com/mobz/elasticsearch-head.git</p>
<p>//进入根目录</p>
<p>（2）cd elasticsearch-head</p>
<p>//安装</p>
<p>（3）npm install</p>
<p>//启动</p>
<p>（4）nohup grunt server &amp;</p>
<p>这里需要注意es5的head不再是es的插件而是需要单独作为一个服务提供，上面我们安装es时，最后两行配置属性是开启了es的跨域访问，所以head作为一个单独的服务，是可以访问es集群的。</p>
<p>此外es5的head安装依赖nodejs环境，所以我们要安装node 步骤如下：</p>
<p>这里采用的是下载官网编译好的二进制包直接安装</p>
<p>（1）wget <a target="_blank" rel="noopener" href="https://nodejs.org/dist/v8.9.4/node-v8.9.4-linux-x64.tar.xz">https://nodejs.org/dist/v8.9.4/node-v8.9.4-linux-x64.tar.xz</a></p>
<p>（2）xz -d node-v8.9.4-linux-x64.tar.xz </p>
<p>（3）设置全局环境变量</p>
<p>export NODE_HOME=/usr/local/node/8.9.4</p>
<p>export PATH=$NODE_HOME/bin:$PATH</p>
<p>（4）验证</p>
<p>head只需要在一台es节点上安装即可</p>
<p><strong>1.5 IK**</strong>分词器的安装**</p>
<p>（1）下载源码</p>
<p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip//%E8%BF%9B%E5%85%A5%E6%A0%B9%E7%9B%AE%E5%BD%95">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip//进入根目录</a></p>
<p>（2）cd elasticsearch-6.2.2 </p>
<p>（3）./bin/elasticsearch-plugin install <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip</a></p>
<p>重启elasticsearch、</p>
<p><a target="_blank" rel="noopener" href="http://192.168.102.151:9200/_analyze?analyzer=ik_max_word&amp;text=iphonex">http://192.168.102.151:9200/_analyze?analyzer=ik_max_word&amp;text=iphonex</a> &amp;pretty=true</p>
<p>常见问题：</p>
<p>通过手动重新分配分片（curl -XPOST esip:9200/_cluster/reroute?retry_failed=true ）解决unassigned</p>

    </div>
</article>
            </div>
            <div class="aside">
    
        <div class="box widget">
    <div class="introduction">
        <p><img src="/images/avatar.jpg" alt="head-sculpture" /></p>
        <p class="name">
            xuesongtan
        </p>
        <p class="slogan">流连矣 忘景幻云催 峦栈醺醺说旧梦 重山迟迟映霞辉 向晚共邀归</p>
    </div>
</div>
    
        
<div class="box widget">
    <div class="title">Recent</div>
    <ul class="item-box">
        
            
                <li><a href="/2020/12/03/Docker%E6%95%99%E7%A8%8B%E8%AE%B2%E8%A7%A3/">Docker 教程讲解</a></li>
            
        
            
                <li><a href="/2020/11/03/Docker%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E6%90%AD%E5%BB%BA/">Docker 搭建私有仓库</a></li>
            
        
            
                <li><a href="/2020/10/03/Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">Docker 命令大全</a></li>
            
        
            
                <li><a href="/2020/09/03/Dockerfile%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F/">Docker Dockerfile</a></li>
            
        
            
                <li><a href="/2020/08/03/Elasticsearch%E9%9B%86%E7%BE%A4/">Elasticsearch集群搭建</a></li>
            
        
            
                <li><a href="/2020/07/03/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程讲解</a></li>
            
        
            
                <li><a href="/2020/06/03/Maven%E7%9F%A5%E8%AF%86%E5%BA%93/">Maven知识库</a></li>
            
        
            
                <li><a href="/2020/06/03/Redis%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/">Redis集群安装部署</a></li>
            
        
    </ul>
</div>

    
        
    
        
  <div class="box widget">
    <div class="title">Archives</div>
    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">2020-12</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">2020-11</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">2020-10</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">2020-09</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">2020-08</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">2020-07</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">2020-06</a><span class="archive-list-count">2</span></li></ul>
  </div>

    
        
    
</div>
        </section>
        <footer class="footer">
    <div class="global-width footer-box">
        <div class="copyright">
            <span>Copyright &copy; 2019</span>
            <span class="dotted">|</span>
            <span>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span>
            <span class="dotted">|</span>
            <span>Theme by <a href="javascript:">Loren</a></span>
            <span class="dotted">|</span>
            <span><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn">浙ICP备18016660号-1</a></span>
        </div>
    </div>
</footer>
    </div>

<script>
    hljs.initHighlightingOnLoad();
</script>
</body>
</html>