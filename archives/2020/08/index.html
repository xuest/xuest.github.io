<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">




    <meta name="keywords" content=""/>



    <meta name="description" content=""/>


<meta name="Robots" content="all">


    <title>Augustxuesong</title>


<link rel="icon" href="/images/favicon.ico">

<link rel="stylesheet" href="/css/font-awesome.min.css">


<link rel="stylesheet" href="/css/atom-one-dark.css">


<link rel="stylesheet" href="/css/style.css">


<script src="/js/highlight.min.js"></script>

<meta name="generator" content="Hexo 5.2.0"></head>
<body>
    <div class="main-container">
        <header class="header">
    <div class="global-width">
        <nav class="nav-box">
            
                <a class="nav-item" href="/"
                
                >Home</a>
            
                <a class="nav-item" href="/resume"
                
                >Resume</a>
            
                <a class="nav-item" href="/mood"
                
                   target="_blank"
                
                >Mood</a>
            
                <a class="nav-item" href="/amusement/tetris"
                
                   target="_blank"
                
                >Amusement</a>
            
                <a class="nav-item" href="/about"
                
                >About</a>
            
        </nav>
    </div>
</header>

        <section class="content global-width">
            <div class="main">
                
    
        <article class="box post post-item">
            <div class="post-title"><a href="/2020/08/03/Elasticsearch%E9%9B%86%E7%BE%A4/">Elasticsearch集群搭建</a></div>
            <div class="post-meta">
                
                <i class="fa fa-calendar"></i> <time>2020-08-03</time>
                <span class="dotted">|</span>
                <i class="fa fa-user"></i> 
            </div>

            <div class="post-excerpt">
                <a href="/2020/08/03/Elasticsearch%E9%9B%86%E7%BE%A4/">
                    <p>
                        
                            Elasticsearch集群搭建1.1 安装准备
1.1.1**下载安装包**
https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.2.2.tar.gz
1.1.2 服务器准备
为搭建ElasticSearch集群，准备了二台服务器，主机IP分别为：



服务器IP
系统版本



192.168.102.151
Centos7.5


192.168.102.11
Centos7.5






1.1.3 新建用户
ES不支持root用户启动，分别使用root用户登录服务器新建es用户,并设置密码，然后给用户文件夹所有权
# 新增用户
useradd es
# 设置密码
passwd es
# 授权
chown es /home/es
# 新建es数据文件夹和日志文件夹
mkdir -p /opt/es/logs
mkdir -p /opt/es/data
chown es /opt/es/
chown es /opt/es/logs/
chown es /opt/es/data/
# 准备安装包
1、jdk-8u144-linux-x64.tar.gz 2、elasticsearch-6.2.2.tar.gz
1.1.4 调整系统参数
1.1.3.1 内核参数调整
vim /etc/sysctl.conf
# 增加下面的内容
fs.file-max = 65536
vm.max_map_count = 262144
# 执行命令
sysctl -p
1.1.3.2 资源参数调整
vim /etc/security/limits.conf
# 修改
* soft nofile 65536
* hard nofile 65536
* soft nproc 2048
* hard nproc 4096
es soft memlock unlimited
es hard memlock unlimited
1.1.3.3 调整线程数
vim /etc/security/limits.d/90-nproc.conf
找到如下内容：
* soft nproc 1024
#修改为
* soft nproc 2048
1.2 JDK**安装**
登录es用户，进入/opt文件夹，解压JDK安装包 ES5.0以上必须1.8JDK支持
cd /opt
tar -zxvf /home/es/jdk-8u144-linux-x64.tar.gz
# 设置环境变量
vim /etc/profile
#在文件最下方添加
export JAVA_HOME=/opt/jdk1.8.0_144
export CLASSPATH=$CLASSPATH:$JAVA_HOME/lib/*.jar
export PATH=.:$JAVA_HOME/bin:$PATH
1.3 ES**安装及配置**
1.3.1 解压缩
# 切换到es用户
cd /home/es
tar -zxvf elasticsearch-6.2.2.tar.gz
1.3.2 配置
1.3.2.1 elasticsearch.yml
cluster.name: my-social
node.name: social-151
network.host: 192.168.102.151
node.master: true
node.data: true
path.data: /opt/es/data
path.logs: /opt/es/logs
http.cors.enabled: true
http.ors.allow-origin: “*”
discovery.zen.ping.unicast.hosts: [“192.168.102.11”,”192.168.102.151”]                                  
# 集群名称，各个节点的值必须一致
cluster.name: elasticsearch_production
# 节点名称，区分节点，各个节点的值不能一致
node.name: node-1
# 数据文件路径
path.data: /opt/es/data
# 日志文件路径
path.logs: /opt/es/logs
# 设置为true来锁住内存。因为当jvm开始swapping时es的效率会降低，所以要保证它不swap，可以把ES_MIN_MEM和ES_MAX_MEM两个环境变量设置成同一个值，并且保证机器有足够的内存分配给es。同时也要允许elasticsearch的进程可以锁住内存，Linux下可以通过ulimit -l unlimited命令
bootstrap.memory_lock: true
# 因为Centos6不支持SecComp，而ES5.6.4默认bootstrap.system_call_filter为true进行检测，所以导致检测失败，失败后直接导致ES不能启动
bootstrap.system_call_filter: false
# 本机IP
network.host: 192.168.6.104
# 单播列表
discovery.zen.ping.unicast.hosts: [“192.168.102.151”, “192.168.102.11”, “192.168.102.40”]
# 防止脑裂，官方推荐设置成 N/2 + 1，N是集群中master节点的数量
discovery.zen.minimum_master_nodes: 2
# 存在至少2个节点（数据节点或者 master 节点）才进行数据恢复
gateway.recover_after_nodes: 2
# 等待10分钟，或者3个节点上线后，才进行数据恢复，这取决于哪个条件先达到
gateway.expected_nodes: 3
gateway.recover_after_time: 10m
# 禁用xpack安全认证
xpack.security.enabled: false
1.3.2.2 jvm.options
# 调整内存大小根据系统资源而定，最好不要超过总资源一半
-Xms8g
-Xmx8g
1.3.2.3 elasticsearch**和elasticsearch-plugin**
可选步骤，如果环境变量配置JDK为1.8不需要配置，若需要多JDK共同使用则需要配置
export JAVA_HOME=/opt/jdk1.8.0_144
export CLASSPATH=$CLASSPATH:$JAVA_HOME/lib/*.jar
export PATH=.:$JAVA_HOME/bin:$PATH
1.3.4 启动
cd /home/es/elasticsearch-6.2.2/bin
# 控制台启动，加 -d 参数可以后台启动
./elasticsearch    
# 查看节点状态
curl -XGET ‘192.168.102.151:9200/_cat/nodes?v’
# 查看集群状态
curl -XGET ‘192.168.102.11:9200/_cat/health?v’
1.4 head**的安装**
//下载源码
（1）git clone git://github.com/mobz/elasticsearch-head.git
//进入根目录
（2）cd elasticsearch-head
//安装
（3）npm install
//启动
（4）nohup grunt server &amp;
这里需要注意es5的head不再是es的插件而是需要单独作为一个服务提供，上面我们安装es时，最后两行配置属性是开启了es的跨域访问，所以head作为一个单独的服务，是可以访问es集群的。
此外es5的head安装依赖nodejs环境，所以我们要安装node 步骤如下：
这里采用的是下载官网编译好的二进制包直接安装
（1）wget https://nodejs.org/dist/v8.9.4/node-v8.9.4-linux-x64.tar.xz
（2）xz -d node-v8.9.4-linux-x64.tar.xz 
（3）设置全局环境变量
export NODE_HOME=/usr/local/node/8.9.4
export PATH=$NODE_HOME/bin:$PATH
（4）验证
head只需要在一台es节点上安装即可
1.5 IK**分词器的安装**
（1）下载源码
https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip//进入根目录
（2）cd elasticsearch-6.2.2 
（3）./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip
重启elasticsearch、
http://192.168.102.151:9200/_analyze?analyzer=ik_max_word&amp;text=iphonex &amp;pretty=true
常见问题：
通过手动重新分配分片（curl -XPOST esip:9200/_cluster/reroute?retry_failed=true ）解决unassigned

                        
                    </p>
                </a>
            </div>

            
        </article>
    



            </div>
            <div class="aside">
    
        <div class="box widget">
    <div class="introduction">
        <p><img src="/images/avatar.jpg" alt="head-sculpture" /></p>
        <p class="name">
            xuesongtan
        </p>
        <p class="slogan">流连矣 忘景幻云催 峦栈醺醺说旧梦 重山迟迟映霞辉 向晚共邀归</p>
    </div>
</div>
    
        
<div class="box widget">
    <div class="title">Recent</div>
    <ul class="item-box">
        
            
                <li><a href="/2020/12/03/Docker%E6%95%99%E7%A8%8B%E8%AE%B2%E8%A7%A3/">Docker 教程讲解</a></li>
            
        
            
                <li><a href="/2020/11/03/Docker%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E6%90%AD%E5%BB%BA/">Docker 搭建私有仓库</a></li>
            
        
            
                <li><a href="/2020/10/03/Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">Docker 命令大全</a></li>
            
        
            
                <li><a href="/2020/09/03/Dockerfile%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F/">Docker Dockerfile</a></li>
            
        
            
                <li><a href="/2020/08/03/Elasticsearch%E9%9B%86%E7%BE%A4/">Elasticsearch集群搭建</a></li>
            
        
            
                <li><a href="/2020/07/03/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程讲解</a></li>
            
        
            
                <li><a href="/2020/06/03/Maven%E7%9F%A5%E8%AF%86%E5%BA%93/">Maven知识库</a></li>
            
        
            
                <li><a href="/2020/06/03/Redis%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/">Redis集群安装部署</a></li>
            
        
    </ul>
</div>

    
        
    
        
  <div class="box widget">
    <div class="title">Archives</div>
    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">2020-12</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">2020-11</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">2020-10</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">2020-09</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">2020-08</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">2020-07</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">2020-06</a><span class="archive-list-count">2</span></li></ul>
  </div>

    
        
    
</div>
        </section>
        <footer class="footer">
    <div class="global-width footer-box">
        <div class="copyright">
            <span>Copyright &copy; 2019</span>
            <span class="dotted">|</span>
            <span>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span>
            <span class="dotted">|</span>
            <span>Theme by <a href="javascript:">Loren</a></span>
            <span class="dotted">|</span>
            <span><a target="_blank" rel="noopener" href="http://www.beian.miit.gov.cn">浙ICP备18016660号-1</a></span>
        </div>
    </div>
</footer>
    </div>

<script>
    hljs.initHighlightingOnLoad();
</script>
</body>
</html>